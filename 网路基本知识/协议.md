## HTTP协议

### 简介

HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网服务器传输超文本到本地浏览器的传送协议。

HTTP协议基于应用层，假定其下层协议提供可靠传输，一般使用TCP协议

### 特点

-   无连接：限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。可以采用Keep-Alive（保活）功能使得接连持续有效
-   无状态：协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。可以采用cookie或session来保存HTTP状态
-   方便灵活：客户请求服务时，只需要发送请求方法和路径即可。允许传输任意类型的数据对象，由Content-Type加以标识

### URI和URL

#### URI

统一资源标识符（Uniform Resource Identifier)，用于标识某一互联网资源名称的字符串

URI的格式由下列三部分组成：第一部分是协议（或称为服务方式）；第二部分是存有该资源的主机IP地址（有时也包括端口号）；第三部分是主机资源的具体地址

#### URL

统一资源定位系统（uniform resource locatorURL是一种URI，它标识一个互联网资源，并指定对其进行操作或获取该资源的方法。URL是URI的子集，即URL是靠标识定位地址的URI

以`http://www.aspxfans.com:8080/news/index.asp?boardID=5&ID=24618&page=1#name` 为例，介绍下普通URL的组成部分

-   协议部分：该URL的协议部分为 `http:` ，这代表网页使用的是HTTP协议，在后面以 `//` 作为分隔符
-   域名部分：该URL的域名部分为 `www.aspxfans.com`。一个URL中，也可以使用IP地址作为域名使用
-   端口部分：跟在域名后面的是端口，域名和端口之间使用 `:` 作为分隔符。端口不是一个URL必须的部分，如果省略端口部分，将采用默认端口
-   虚拟目录部分：从域名后的第一个`/` 开始到最后一个 `/` 为止，是虚拟目录部分。虚拟目录也不是一个URL必须的部分。本例中的虚拟目录是 `/news/`
-   文件名部分：从域名后的最后一个 `/` 开始到 `?` 为止，是文件名部分，如果没有 `?` ,则是从域名后的最后一个 `/` 开始到 `#` 为止，是文件部分，如果没有 `?` 和 `#` ，那么从域名后的最后一个 `/` 开始到结束，都是文件名部分。本例中的文件名是 `index.asp` 。文件名部分也不是一个URL必须的部分，如果省略该部分，则使用默认的文件名
-   参数部分：从 `?` 开始到 `#` 为止之间的部分为参数部分，又称搜索部分、查询部分。本例中的参数部分为 `boardID=5&ID=24618&page=1` 。参数可以允许有多个参数，参数与参数之间用 `&` 作为分隔符
-   锚部分：从 `#` 开始到最后，都是锚部分。本例中的锚部分是 `name`。锚部分的主要作用是指向网页中的一个特定部分或元素，通常用于页面内导航，以便用户或开发者能够快速跳转到页面的某个特定段落或区域。锚部分也不是一个URL必须的部分

### HTTP请求Request

HTTP请求格式：请求行，请求头，空行，请求数据

![img](assets\http_request_format.png\)

POST请求例子

```js
POST / HTTP1.1
Host:www.wrox.com
User-Agent:Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)
Content-Type:application/x-www-form-urlencoded
Content-Length:40
Connection: Keep-Alive

name=Professional%20Ajax&publisher=Wiley
```

请求行：用来说明请求类型,要访问的资源以及所使用的HTTP版本

请求头：用来说明服务器要使用的附加信息

空行：请求头部后面的空行是必须的，即使第四部分的请求数据为空，也必须有空行

请求数据：可以添加任意的其他数据

#### 请求方法

```js
GET			//请求指定的页面信息，并返回实体主体。
HEAD		//类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头
POST		//向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中
PUT			//从客户端向服务器传送的数据取代指定的文档的内容。
DELETE		//请求服务器删除指定的页面。
CONNECT		//HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。
OPTIONS		//允许客户端查看服务器的性能。
TRACE		//回显服务器收到的请求，主要用于测试或诊断。
```

#### GET和POST请求的区别

GET请求

```js
GET /books/?sex=man&name=Professional HTTP/1.1
Host: www.wrox.com
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)
Gecko/20050225 Firefox/1.0.1
Connection: Keep-Alive

```

POST请求

```js
POST / HTTP/1.1
Host: www.wrox.com
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.6)
Gecko/20050225 Firefox/1.0.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 40
Connection: Keep-Alive

name=Professional%20Ajax&publisher=Wiley
```

-   提交数据
    -   GET：请求的数据会附在URL之后（就是把数据放置在HTTP协议头中），以?分割URL和传输数据，多个参数用&连接；如果数据是英文字母/数字，原样发送，如果是空格，转换为+，如果是中文/其他字符，则直接把字符串用BASE64加密，得出如： %E4%BD%A0%E5%A5%BD，其中％XX中的XX为该符号以16进制表示的ASCII
    -   POST：把提交的数据放置请求体中
-   传输数据大小
    -   GET：虽然HTTP协议没有对传输的数据大小进行限制，HTTP协议规范也没有对URL长度进行限制。但是特定浏览器和服务器对URL长度有限制，例如 IE对URL长度的限制是2083字节(2K+35)。对于其他浏览器，如Netscape、FireFox等，理论上没有长度限制，其限制取决于操作系统的支持。因此对于GET提交时，传输数据就会受到URL长度的限制
    -   POST：由于不是通过URL传值，理论上数据不受限。但实际各个WEB服务器会规定对post提交数据大小进行限制，Apache、IIS6都有各自的配置
-   安全性：GET方式提交数据，会带来安全问题，比如一个登录页面，通过GET方式提交数据时，用户名和密码将出现在URL上，如果页面可以被缓存或者其他人可以访问这台机器，就可以从历史记录获得该用户的账号和密码

### HTTP响应Response

HTTP响应格式：状态行、消息报头、空行和响应正文

响应例子

```js
HTTP/1.1 200 OK
Date: Fri, 22 May 2009 06:07:21 GMT
Content-Type: text/html; charset=UTF-8

<html>
      <head></head>
      <body>
            <!--body goes here-->
      </body>
</html>
```

状态行：由HTTP协议版本号，状态码，状态消息三部分组成

消息报头：用来说明客户端要使用的一些附加信息

空行：消息报头后面的空行是必须的

响应正文：服务器返回给客户端的文本信息

#### 状态码

状态代码有三位数字组成，第一个数字定义了响应的类别，共分五种类别:

-   1xx：指示信息--表示请求已接收，继续处理
-   2xx：成功--表示请求已被成功接收、理解、接受
-   3xx：重定向--要完成请求必须进行更进一步的操作
-   4xx：客户端错误--请求有语法错误或请求无法实现
-   5xx：服务器端错误--服务器未能实现合法的请求

常见状态码：

```js
200 OK                        //客户端请求成功
400 Bad Request               //客户端请求有语法错误，不能被服务器所理解
401 Unauthorized              //请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用 
403 Forbidden                 //服务器收到请求，但是拒绝提供服务
404 Not Found                 //请求资源不存在，eg：输入了错误的URL
500 Internal Server Error     //服务器发生不可预期的错误
503 Server Unavailable        //服务器当前不能处理客户端的请求，一段时间后可能恢复正常
```

## DHCP协议

动态主机设置协议（Dynamic Host Configuration Protocol），又称动态主机组态协定，是一个用于IP网络的网络协议，位于OSI模型的应用层，使用UDP协议工作，主要有两个用途：

-   用于内部网或网络服务供应商自动分配IP地址给用户
-   用于内部网管理员对所有电脑作中央管理

### 报文格式

![image-20240807152804836](assets\image-20240807152804836.png)

-   op：报文的操作类型，分为请求报文和响应报文，1为请求报文；2为响应报文。具体的报文类型在option字段中标识
-   htype：表示client硬件地址的类型，1表示以太网类型
-   hlen：硬件地址的长度，以太网的硬件地址长度为6bytes
-   hops：表示当前DHCP报文经过的DHCP中继的数目，每经过一个DHCP中继这个字段就加1
-   xid：由client端产生的随机数，用于匹配请求和应答报文
-   secs：客户端进入IP地址申请进程的时间或者更新IP地址进程的时间；由客户端软件根据情况设定。目前没有使用，固定为0
-   flags：标志字段，16比特中只使用了最高位比特（即最左边的比特），这个个比特是广播响应标识位，用来标识DHCP服务器发出的响应报文是广播还是单播，0是单播，1是广播。其余的比特位保留不用，都为0
-   ciaddr：客户端的IP地址，可以是client自己的IP地址，也可以是server分配给client的IP地址
-   yiaddr(Your IP Address)：是server分配给client的IP地址
-   siaddr：client端获取IP地址等信息的server端的地址
-   giaddr：client发出请求报文后经过的第一个中继的IP地址
-   chaddr：client端的硬件地址，在client发出报文时会把自己网卡的硬件地址写进这个字段。
-   sname：服务器主机名，是client端获取IP地址等信息的服务器名称。
-   file：client的启动配置文件名，是服务器为client指定的启动配置文件名及路径信息，由服务器填写
-   options：是可选变长的选项字段，这个字段包含了终端的初始配置信息和网络配置信息，包括报文类型，有效租期，DNS服务器的IP地址等配置信息

其中option为变长的选项字段，格式为CLV结构：

![image-20240807153452462](assets\image-20240807153452462.png)

不同code代表不同的option

![image-20240807154028421](assets\image-20240807154028421.png)

### DHCP协议报文的种类

-   DHCP-DISCOVER报文：0x01  客户端请求包——广播

    这个报文是client端开始dhcp过程的第一个请求报文，client在请求地址时，并不知道server端的位置，所以client会以广播的方式发送请求报文，它的目的是发现网络中的服务器。

-   DHCP-OFFER报文： 0x02  服务器响应包——取决于Discover的Bootp flags字段

    这个报文server端对DISCOVERY报文的响应报文。会在所配置的地址池中查找一个合适的IP地址，加上相应的租约期限和其他配置信息（如GATEWAY，DNS SERVER等），构造一个OFFER报文，发送给用户，告知用户本SERVER可以为其提供IP地址的分配

-   DHCP-REQUEST报文：0x03 客户端选择包——首次租用阶段广播，续约单播

    在一个子网中可能有多台服务器，所有收到DISCOVER报文的服务器都会回应OFFER报文，所以client端可能收到多个OFFER报文，通常会选择第一个OFFER报文的服务器作为自己的目标服务器，并回应一个REQUEST请求报文。在续租约的时候client端也会发送REQUEST报文，请求续租期

-   DHCP-DECLINE报文：0x04

    client收到server回应的ACK报文后，通过地址冲突检测发现 SERVER分配的地址冲突或由于其它原因导致不能使用，则发送DHCP-DECLINE报文，通知server所分配的IP地址不可用

-   DHCP-ACK报文：0x05  服务器确认包——首次租用阶段取决于Request的Bootp flags字段，续约单播

    是server对client端的REQUEST报文的确认响应报文，server在收到REQUEST报文后，根据REQUEST报文中携带的client MAC来查找有没有相应的租约记录，如果有则发送ACK报文作为回应，通知client可以使用分配的IP地址

-   DHCP-NAK报文：0x06  服务器拒绝包——广播

    server端对client端的REQUEST报文的拒绝响应报文，如果服务器没有相应的租约记录，就会发送NAK报文给client端

-   DHCP-RELEASE报文：0x07  客户端释放包——单播

    client端主动释放server端分配给它的IP时，就会发送DHCP-RELEASE报文给server，server收到这个报文后，就会回收这个IP地址

-   DHCP-INFORM报文：0x08

    在client已经获得了IP地址，需要从server端获得更详细的配置信息时，就会发送DHCP-INFORM报文向server请求，server在收到这个报文后，会根据租约查找，找到相应的配置信息后，就会回应DHCP-ACK报文给client

### 动态获取IP过程

![image-20240807165632905](assets\image-20240807165632905.png)

### 抓包过程

-   ipconfig /release 断开当前网络，发送DHCP-RELEASE报文

![image-20240807174951501](assets\image-20240807174951501.png)

-   ipconfig /renew 重新申请ip

![image-20240807175140831](assets\image-20240807175140831.png)

## DNS协议

### 简介

DNS( Domain Name System)是“域名系统”的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，它用于TCP/IP网络，它所提供的服务是用来将主机名和域名转换为IP地址的工作。

DNS 在设计之初就引入了 TCP 协议 ，但在查询中一般使用 UDP 协议 ，它同时占用了 UDP 和 TCP 的 53 端口。数据包小于512字节，使用UDP协议。但是如果返回的请求大小大于512字节，交互双方会协商使用TCP协议。

### 域名结构

DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构：

-   根域名服务器（Root DNS Server）：管理顶级域名服务器，返回com, net, cn等顶级域名服务器的 IP 地址
-   顶级域名服务器（Top-level DNS Server）：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址
-   权威域名服务器（Authoritative DNS Server）：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 `www.pzijun.cn` 的 IP 地址

![img](assets\7171cbec7a2049fbab0a9556e5824938.png)

### DNS 查询方式

递归：查询DNS客户端设置使用的 DNS 服务器

迭代：查询DNS根域名服务器，以免根域名服务器的压力过大

### DNS完整查询过程

1.  首先搜索浏览器的 DNS 缓存 ，缓存中维护一张域名与 IP 地址的对应表
2.  如果没有命中，则继续搜索操作系统的 DNS 缓存
3.  如果依然没有命中，则操作系统将域名发送至本地域名服务器 ，本地域名服务器查询自己的 DNS 缓存，查找成功则返回结果（注意：主机和本地域名服务器之间的查询方式是递归查询 ）
4.  若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行 迭代查询 （注意：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大）：

5.   首先本地域名服务器向根域名服务器发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址，也就是说给本地域名服务器指明一条道路，让他去这里寻找答案

6.   本地域名服务器拿到这个顶级域名服务器的地址后，就向其发起请求，获取权限域名服务器的地址

7.   本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址

8.   本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址缓存起来

9.   操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来

10.   至此， 浏览器就得到了域名对应的 IP 地址，并将 IP 地址缓存起来

### 报文格式

![image-20240807195500754](assets\image-20240807195500754.png)

-   标识：标记DNS查询和应答，以区分哪一个DNS应答对应哪个DNS查询的回应 
-   标志位：协商具体的通信方式和反馈通信状态
    -   QR（Query/Response，1位）： 0-查询（Query），1-响应（Response
    -   Opcode（ 4位）：指示DNS查询的类型。常见的值包括：
        -   0000: 标准查询（Standard Query）
        -   0001: 反向查询（Inverse Query）
        -   0010: 服务器状态请求（Server Status Request）
    -   AA（Authoritative，1位）：0-非权威回答，1-权威回答，仅应答报文可用
    -   TC（Truncation，1位）：0-不截断，1-截断
    -   RD（Recursion Desired，1位）：0-不希望递归，1-希望递归
    -   RA（Recursion Available，1位）：0-不支持递归，1-支持递归，仅应答报文可用
    -   Z（1位）：保留位，应该设置为0。用于将来扩展或其他用途。
    -   AD（Answer authenticated，1位）：AD 位被设置，则意味着服务器已确认数据是经过安全认证的
    -   CD（Non-authenticated data，1位）：当解析器在查询中设置 CD 位时，它表示不希望服务器检查数据的有效性，并且愿意接受更快的响应，而不必等待服务器执行验证。这可以减少延迟，因为服务器可以更快地返回响应。如果 CD 位没有设置，服务器将会验证数据，并且只有在能够确认数据的真实性时才会返回经过认证的响应
    -   RCODE（Reply Code，4位）：指示响应的状态码。常见的值包括：
        -   0000: 无错误（No Error）
        -   0001: 格式错误（Format Error）
        -   0010: 服务器失败（Server Failure）
        -   0011: 名称错误（Name Error）
        -   0100: 查询被拒绝（Query Refused）

![image-20240807203419957](assets\image-20240807203419957.png)

-   问题个数：问题节中的资源个数
-   应答资源个数：应答节中的资源个数
-   授权资源记录数目：授权节中的资源个数
-   额外资源记录数目：额外节中的资源个数 

#### 查询问题

待查询域名保存作为查询问题保存在问题节中。问题节支持保存多条问题记录，问题个数则保存在DNS头部的问题个数中。

一个问题记录由3个字段组成：

-   待查询域名（Name）：长度不定，由具体域名确定
-   查询类型（Type）：域名除了关联 IP 地址，还可以关联其他信息，常见类型包括
    -   1 表示 A 记录，即 IP 地址
    -   28 表示 AAAA 记录，即 IPv6 地址

-   类（ Class ）：一般为1，表示TCP/IP互联网地址

#### 应答资源

服务端处理查询请求后，需要向客户端发送应答报文；域名查询结果作为资源记录，保存在答案以及其后两节中。答案节、授权信息节和附加信息节均由一条或多条资源记录组成，记录数目保存在头部中的对应字段

资源记录结构和问题记录非常相似，它总共有 6 个字段，前 3 个和问题记录完全一样：

-   被查询域名（ Name ）：与问题记录相同；
-   查询类型（ Type ）：与问题记录de相同；
-   类（ Class ）：与问题记录相同；
-   有效期（ TTL ）：域名记录一般不会频繁改动，所以在有效期内可以将结果缓存起来，降低请求频率；
-   数据长度（ Resource Data Length ）：即查询结果的长度，假如是IPv4则数据长度为4；
-   数据（ Resource Data ）：即查询结果；

### DNS代理

DNS代理（DNS Proxy）是一种网络服务，它充当DNS客户端和DNS服务器之间的中介。其主要功能是接收DNS查询请求，将其转发到上游DNS服务器进行解析，并将响应结果返回给请求的客户端

提供DNS代理一般有以下：

-   **互联网服务提供商 (ISP)**：大多数用户的互联网服务提供商都会提供基础的DNS解析服务，用户在连接到互联网时，通常会自动使用ISP提供的DNS服务器。

-   **公共DNS服务**：一些公司和组织提供公共DNS服务，用户可以自由使用。例如：

-   **组织和企业内部DNS**：大型企业和组织通常会建立自己的内部DNS服务器，用于管理内部网络资源和用户访问。

### 首选DNS和备用DNS

-   **首选DNS**：首选DNS服务器负责存储和维护域名解析记录（如A记录、CNAME记录等）。当用户请求访问某个域名时，主DNS会首先被查询，以获取该域名对应的IP地址。

-   **备用DNS**：备用DNS服务器是为了提高DNS解析的可靠性和容错性。在主DNS不可用或出现故障时，备用DNS将接管解析请求，从而确保域名解析服务的持续可用性。备用DNS通常会定期从主DNS同步数据，以确保其有最新的记录。